---
title: "Análisis de Intersección"
author: "Aarón García Blázquez"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r libraries, echo=FALSE}
rm(list = ls())

require(dplyr)
require(ggplot2)
require(gridExtra)
require(VennDiagram)
require(MetBrewer)
```

```{r data load, echo=FALSE}
data_dir <- "data/differential_expression/"

load(paste0(data_dir,"tt_72_48.RData"))
tt_72_48_control <- tt_72_48$table
rownames(tt_72_48_control) <- tt_72_48_control$ind

load(paste0(data_dir,"tt_120_72.RData"))
tt_120_72_control <- tt_120_72$table
rownames(tt_120_72_control) <- tt_120_72_control$ind

load(paste0(data_dir,"tt_Adult_120.RData"))
tt_Adult_120_control <- tt_Adult_120$table
rownames(tt_Adult_120_control) <- tt_Adult_120_control$ind

# Resultados empleando Combat

load(paste0(data_dir,"tt_72_48_combat.RData"))
rownames(tt_72_48_combat) <- tt_72_48_combat$ind

load(paste0(data_dir,"tt_120_72_combat.RData"))
rownames(tt_120_72_combat) <- tt_120_72_combat$ind

load(paste0(data_dir,"tt_Adult_120_combat.RData"))
rownames(tt_Adult_120_combat) <- tt_Adult_120_combat$ind

# Resultados empleando SVA

load(paste0(data_dir,"tt_72_48_sva.RData"))
rownames(tt_72_48_sva) <- tt_72_48_sva$ind

load(paste0(data_dir,"tt_120_72_sva.RData"))
rownames(tt_120_72_sva) <- tt_120_72_sva$ind

load(paste0(data_dir,"tt_Adult_120_sva.RData"))
rownames(tt_Adult_120_sva) <- tt_Adult_120_sva$ind
```

```{r names, echo=FALSE}
n_ups <- NULL
n_downs <- NULL
contrasts_names <- c("72hpf vs 48hpf", "120hpf vs 72hpf", "Adult vs 120hpf")
batch_names <- c("Control", "ComBat", "SVA")
```

# Selección de genes {.tabset}

## Control {.tabset}

### 72 hpf vs 48 hpf

```{r control 1}
diff_df <- tt_72_48_control[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

control_1_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
control_1_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(control_1_ups)))
print(paste0("Genes downregulated: ", length(control_1_downs)))
```

### 120 hpf vs 72 hpf

```{r control 2}
diff_df <- tt_120_72_control[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

control_2_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
control_2_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(control_2_ups)))
print(paste0("Genes downregulated: ", length(control_2_downs)))
```

### Adult vs 120 hpf

```{r control 3}
diff_df <- tt_Adult_120_control[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

control_3_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
control_3_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(control_3_ups)))
print(paste0("Genes downregulated: ", length(control_3_downs)))
```

## ComBat {.tabset}

### 72 hpf vs 48 hpf

```{r combat 1}
diff_df <- tt_72_48_combat[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

combat_1_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
combat_1_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(combat_1_ups)))
print(paste0("Genes downregulated: ", length(combat_1_downs)))
```

### 120 hpf vs 72 hpf

```{r combat 2}
diff_df <- tt_120_72_combat[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

combat_2_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
combat_2_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(combat_2_ups)))
print(paste0("Genes downregulated: ", length(combat_2_downs)))
```

### Adult vs 120 hpf

```{r combat 3}
diff_df <- tt_Adult_120_combat[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

combat_3_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
combat_3_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(combat_3_ups)))
print(paste0("Genes downregulated: ", length(combat_3_downs)))
```

## SVA {.tabset}

### 72 hpf vs 48 hpf

```{r sva 1}
diff_df <- tt_72_48_sva[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

sva_1_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
sva_1_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(sva_1_ups)))
print(paste0("Genes downregulated: ", length(sva_1_downs)))
```

### 120 hpf vs 72 hpf

```{r sva 2}
diff_df <- tt_120_72_sva[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

sva_2_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
sva_2_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(sva_2_ups)))
print(paste0("Genes downregulated: ", length(sva_2_downs)))
```

### Adult vs 120 hpf

```{r sva 3}
diff_df <- tt_Adult_120_sva[,c("logFC", "FDR")]
diff_df$gene_name <- rownames(diff_df)

diff_df$group <- "N.S."

diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] > 1.5 ),"group"] <- "Up"
diff_df[which(diff_df['FDR'] < 0.05 & diff_df['logFC'] <  -1.5 ),"group"] <- "Down"

n_ups <- c(n_ups,length(which(diff_df$group == "Up")))
n_downs <- c(n_downs,length(which(diff_df$group == "Down")))

sva_3_ups <- rownames(diff_df[which(diff_df["group"] == "Up"),])
sva_3_downs <- rownames(diff_df[which(diff_df["group"] == "Down"),])

print(paste0("Genes upregulated: ", length(sva_3_ups)))
print(paste0("Genes downregulated: ", length(sva_3_downs)))
```

# {-}

&nbsp;

# Intersección de genes significativos {.tabset}

## Control {.tabset}

### Upregulated

```{r venn control up}
D_ups <- list(control_1_ups, control_2_ups, control_3_ups)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = contrasts_names,
                          filename = "plots/venn_control_up.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)            
```

```{r venn control up plot, out.width='75%'}
knitr::include_graphics("plots/venn_control_up.png")
```

### Downregulated

```{r venn control down}
D_downs <- list(control_1_downs, control_2_downs, control_3_downs)

VennDiagram::venn.diagram(x = D_downs,
                          category.names = contrasts_names,
                          filename = "plots/venn_control_down.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)            
```

```{r venn control down plot, out.width='75%'}
knitr::include_graphics("plots/venn_control_down.png")
```

## ComBat {.tabset}

### Upregulated

```{r venn combat up}
D_ups <- list(combat_1_ups, combat_2_ups, combat_3_ups)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = contrasts_names,
                          filename = "plots/venn_combat_up.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)            
```

```{r venn combat up plot, out.width='75%'}
knitr::include_graphics("plots/venn_control_up.png")
```

### Downregulated

```{r venn combat down}
D_downs <- list(combat_1_downs, combat_2_downs, combat_3_downs)

VennDiagram::venn.diagram(x = D_downs,
                          category.names = contrasts_names,
                          filename = "plots/venn_combat_down.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)            
```

```{r venn combat down plot, out.width='75%'}
knitr::include_graphics("plots/venn_control_down.png")
```

## SVA {.tabset}

### Upregulated

```{r venn sva up}
D_ups <- list(sva_1_ups, sva_2_ups, sva_3_ups)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = contrasts_names,
                          filename = "plots/venn_sva_up.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)            
```

```{r venn sva up plot, out.width='75%'}
knitr::include_graphics("plots/venn_sva_up.png")
```

### Downregulated

```{r venn sva down}
D_downs <- list(sva_1_downs, sva_2_downs, sva_3_downs)

VennDiagram::venn.diagram(x = D_downs,
                          category.names = contrasts_names,
                          filename = "plots/venn_sva_down.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)            
```

```{r venn sva down plot, out.width='75%'}
knitr::include_graphics("plots/venn_sva_down.png")
```


&nbsp;

# Intersección por método de corrección del efecto batch {.tabset}

## 72 hpf vs 48 hpf {.tabset}

### Upregulated

```{r venn 1 up}
D_ups <- list(control_1_ups, combat_1_ups, sva_1_ups)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = batch_names,
                          filename = "plots/venn_72_48_batch_up.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)
```

```{r venn 1 up plot, out.width='75%'}
knitr::include_graphics("plots/venn_72_48_batch_up.png")
```

### Downregulated

```{r venn 1 down}
D_ups <- list(control_1_downs, combat_1_downs, sva_1_downs)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = batch_names,
                          filename = "plots/venn_72_48_batch_down.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)           
```

```{r venn 1 down plot, out.width='75%'}
knitr::include_graphics("plots/venn_72_48_batch_down.png")
```

## 120 hpf vs 72 hpf {.tabset}

### Upregulated

```{r venn 2 up}
D_ups <- list(control_2_ups, combat_2_ups, sva_2_ups)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = batch_names,
                          filename = "plots/venn_120_72_batch_up.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)
```

```{r venn 2 up plot, out.width='75%'}
knitr::include_graphics("plots/venn_120_72_batch_up.png")
```

### Downregulated

```{r venn 2 down}
D_ups <- list(control_2_downs, combat_2_downs, sva_2_downs)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = batch_names,
                          filename = "plots/venn_120_72_batch_down.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)           
```

```{r venn 2 down plot, out.width='75%'}
knitr::include_graphics("plots/venn_120_72_batch_down.png")
```

## Adult vs 120 hpf {.tabset}

### Upregulated

```{r venn 3 up}
D_ups <- list(control_3_ups, combat_3_ups, sva_3_ups)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = batch_names,
                          filename = "plots/venn_Adult_120_batch_up.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)
```

```{r venn 3 up plot, out.width='75%'}
knitr::include_graphics("plots/venn_Adult_120_batch_up.png")
```

### Downregulated

```{r venn 3 down}
D_ups <- list(control_3_downs, combat_3_downs, sva_3_downs)

VennDiagram::venn.diagram(x = D_ups,
                          category.names = batch_names,
                          filename = "plots/venn_Adult_120_batch_down.png",
                          output = TRUE,
                          imagetype = "png",
                          height = 480 , 
                          width = 720 , 
                          resolution = 300,
                          compression = "lzw",
                          lwd = 1,
                          col=c("#440154ff", '#21908dff', '#fde725ff'),
                          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
                          cex = 0.5,
                          fontfamily = "sans",
                          cat.cex = 0.3,
                          cat.default.pos = "outer",
                          cat.pos = c(-27, 27, 135),
                          cat.dist = c(0.055, 0.055, 0.085),
                          cat.fontfamily = "sans",
                          cat.col = "black",
                          rotation = 1)        
```

```{r venn 3 down plot, out.width='75%'}
knitr::include_graphics("plots/venn_Adult_120_batch_down.png")
```

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
